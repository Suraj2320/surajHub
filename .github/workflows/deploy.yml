name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:

env:
  AWS_REGION: us-east-1

jobs:

  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # -----------------------------
    # ðŸ” Configure AWS Credentials
    # -----------------------------
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # -----------------------------
    # ðŸ” Login to ECR (SAFE, masked)
    # -----------------------------
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    # -----------------------------
    # ðŸ³ Build & Push Docker Image
    # -----------------------------
    - name: Build and push to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: surajhub
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                   $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    # -----------------------------
    # ðŸ“„ Get CURRENT ECS Task Definition
    # -----------------------------
    - name: Download current task definition
      run: |
        aws ecs describe-task-definition \
          --task-definition ${{ secrets.ECS_TASK_DEF }} \
          --query taskDefinition > task-definition.json

    # -----------------------------
    # ðŸ“ Replace image in task def
    # -----------------------------
    - name: Update task definition with new image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: surajhub
        IMAGE_TAG: ${{ github.sha }}
      run: |
        NEW_IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        jq --arg IMAGE "$NEW_IMAGE" \
           '.containerDefinitions[0].image = $IMAGE' \
           task-definition.json > new-task-def.json

    # -----------------------------
    # ðŸ“¦ Register new version of task def
    # -----------------------------
    - name: Register new task definition
      id: registerdef
      run: |
        arn=$(aws ecs register-task-definition \
          --cli-input-json file://new-task-def.json \
          --query "taskDefinition.taskDefinitionArn" \
          --output text)
        echo "TASKDEF_ARN=$arn" >> $GITHUB_ENV

    # -----------------------------
    # ðŸš€ Deploy new image to ECS
    # -----------------------------
    - name: Update ECS service
      run: |
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service ${{ secrets.ECS_SERVICE }} \
          --task-definition ${{ env.TASKDEF_ARN }} \
          --force-new-deployment

    # -----------------------------
    # ðŸ”Ž Wait for deployment success
    # -----------------------------
    - name: Verify deployment
      run: |
        aws ecs wait services-stable \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }} \
          --region ${{ env.AWS_REGION }}
